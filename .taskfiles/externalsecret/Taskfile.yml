---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  sync:
    desc: Sync ExternalSecret Resources
    summary: |
      Args:
        context: Cluster 'context' to operate against (required)
        namespace: Namespace the PVC is in (default: default)
        secret: ExternalSecret to sync (required)
    vars:
      CONTEXT: "{{.context}}"
      NAMESPACE: '{{.namespace | default "default"}}'
      SECRET: "{{.secret}}"
    requires:
      vars:
        - context
        - secret
    cmds:
      - kubectl --context {{.CONTEXT}} --namespace {{.NAMESPACE}} annotate externalsecret.external-secrets.io {{.SECRET}} force-sync=$(date +%s) --overwrite
    preconditions:
      - sh: kubectl --context {{.CONTEXT}} --namespace {{.NAMESPACE}} get externalsecret.external-secrets.io {{.SECRET}}
        msg: ExternalSecret not found.

  # Maintain a clean execution
  default:
    silent: true
    cmds: [task -l]
