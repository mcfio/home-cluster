---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  sync:
    desc: Sync ExternalSecret Resources
    summary: |
      Args:
        CONTEXT: Cluster 'context' to operate against (required)
        NAMESPACE: Namespace the ExternalSecret is in (default: default)
        SECRET: ExternalSecret to sync (required)
    requires:
      vars:
        - CONTEXT
        - SECRET
    cmds:
      - kubectl --context {{.CONTEXT}} --namespace {{.NAMESPACE}} annotate externalsecret.external-secrets.io {{.SECRET}} force-sync=$(date +%s) --overwrite
    preconditions:
      - sh: kubectl --context {{.CONTEXT}} --namespace {{.NAMESPACE}} get externalsecret.external-secrets.io {{.SECRET}}
        msg: ExternalSecret not found.

  sync:all:
    desc: Sync all ExternalSecrets for a cluster
    summary: |
      Args:
        CONTEXT: Cluster 'context' to operate against (required)
    vars:
      SECRETS:
        sh: kubectl --context {{.CONTEXT}} get externalsecret --all-namespaces --no-headers -A | awk '{print $1 "|" $2}'
    requires:
      vars:
        - CONTEXT
    cmds:
      - for: { var: SECRETS, split: '' }
        task: sync
        vars:
          CONTEXT: '{{.CONTEXT}}'
          NAMESPACE: '{{$a := split "|" .ITEM}}{{$a._0}}'
          SECRET: '{{$a := split "|" .ITEM}}{{$a._1}}'

  # Maintain a clean execution
  default:
    silent: true
    cmds: [task -l]
