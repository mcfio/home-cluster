---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  sync:
    desc: sync ExternalSecret resources
    vars:
      SECRET: '{{ .SECRET | default "" }}'
      NAMESPACE: '{{ .NAMESPACE | default "default" }}'
    cmds:
      - |
        {{ if eq .SECRET "" }}
        kubectl get externalsecret.external-secrets.io --all-namespaces --no-headers --output custom-columns=":.metadata.namespace,:.metadata.name" \
          | xargs --max-procs=4 -l bash -c 'kubectl -n $0 annotate externalsecret.external-secrets.io $1 force-sync=$(date +%s) --overwrite'
        {{ else }}
        kubectl -n {{.NAMESPACE}} annotate externalsecret.external-secrets.io {{.SECRET}} force-sync=$(date +%s) --overwrite
        {{ end }}
    preconditions:
      - kubectl -n {{.NAMESPACE}} get externalsecret.external-secrets.io {{.SECRET}}
