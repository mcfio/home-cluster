---
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio
  namespace: istio-system
spec:
  hub: docker.io/querycapistio
  tag: 1.11.2-distroless
  profile: minimal

  meshConfig:
    extensionProviders:
    - name: oauth2-proxy
      envoyExtAuthzHttp:
        service: oauth2-proxy.oauth2-proxy.svc.cluster.local
        port: 80
        includeHeadersInCheck: ["authorization", "cookie"]
        headersToUpstreamOnAllow: ["authorization", "path", "x-auth-request-user", "x-auth-request-email", "x-auth-request-access-token"]
        headersToDownstreamOnDeny: ["content-type", "set-cookie"]
    accessLogFile: /dev/stdout
    enableTracing: false
    outboundTrafficPolicy:
      mode: ALLOW_ANY

  components:
    cni:
      enabled: true
    pilot:
      k8s:
        env:
        # disable fsGroup injection on pods
        # ref: https://github.com/istio/istio/issues/26882
        - name: ENABLE_LEGACY_FSGROUP_INJECTION
          value: "false"
        hpaSpec:
          minReplicas: 2
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: istio
                  operator: In
                  values:
                  - pilot
              topologyKey: kubernetes.io/hostname

  values:
    global:
      proxy:
        autoInject: disabled
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 600m
            memory: 128Mi
      proxy_init:
        image: proxyv2
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
          limits:
            cpu: 600m
            memory: 128Mi
