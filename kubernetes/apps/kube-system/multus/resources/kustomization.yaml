---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/refs/tags/v4.1.4/deployments/multus-daemonset-thick.yml
  - network-definition.yaml
patches:
  # https://www.talos.dev/v1.8/kubernetes-guides/network/multus/
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
              - name: kube-multus
                image: ghcr.io/k8snetworkplumbingwg/multus-cni:v4.1.4-thick
                resources:
                  $patch: delete
            initContainers:
              - name: install-multus-binary
                image: ghcr.io/k8snetworkplumbingwg/multus-cni:v4.1.4-thick
                command:
                  - "cp"
                  - "-f"
                  - "/usr/src/multus-cni/bin/multus-shim"
                  - "/host/opt/cni/bin/multus-shim"
                resources:
                  $patch: delete
              - name: install-cni
                image: ghcr.io/siderolabs/install-cni:v1.8.0
                command:
                  - /install-cni.sh
                securityContext:
                  privileged: true
                volumeMounts:
                  - mountPath: /host/opt/cni/bin
                    mountPropagation: Bidirectional
                    name: cnibin
            volumes:
              - name: host-run-netns
                hostPath:
                  path: /var/run/netns/
