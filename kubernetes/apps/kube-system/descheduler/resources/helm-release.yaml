---
# yaml-language-server: $schema=https://kubernetes-schemas.mcf.io/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: descheduler
spec:
  interval: 12h
  chartRef:
    kind: OCIRepository
    name: descheduler
  values:
    replicas: 2
    kind: Deployment
    resources:
      limits: {}
      requests:
        cpu: 10m
        memory: 100Mi
    deschedulerPolicyAPIVersion: descheduler/v1alpha2
    deschedulerPolicy:
      metricsProviders:
      - source: KubernetesMetrics
      policies:
      - name: default
        pluginConfig:
        - name: DefaultEvictor
          args:
            evictFailedBarePods: true
            evictLocalStoragePods: true
            evictSystemCriticalPods: true
        - name: LowNodeUtilization
          args:
            metricsUtilization:
              source: KubernetesMetrics
            thresholds:
              cpu: 20
              memory: 20
              pods: 20
            targetThresholds:
              cpu: 50
              memory: 50
              pods: 50
        - name: RemoveFailedPods
          args:
            reasons:
            - ContainerStatusUnknown
            - NodeAffinity
            - NodeShutdown
            - Terminated
            - UnexpectedAdmissionError
            includingInitContainers: true
            excludeOwnerKinds:
            - Job
            minPodLifetimeSeconds: 1800
        - name: RemovePodsViolatingInterPodAntiAffinity
        - name: RemovePodsViolatingNodeAffinity
          args:
            nodeAffinityType:
            - requiredDuringSchedulingIgnoredDuringExecution
        - name: RemovePodsViolatingNodeTaints
        - name: RemovePodsViolatingTopologySpreadConstraint
        plugins:
          balance:
            enabled:
            - LowNodeUtilization
            - RemovePodsViolatingTopologySpreadConstraint
          deschedule:
            enabled:
            - RemoveFailedPods
            - RemovePodsViolatingInterPodAntiAffinity
            - RemovePodsViolatingNodeAffinity
            - RemovePodsViolatingNodeTaints
    service:
      enabled: true
    serviceMonitor:
      enabled: true
    leaderElection:
      enabled: true
